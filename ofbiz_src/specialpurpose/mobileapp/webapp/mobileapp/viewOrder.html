<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Salesman - Xem đơn hàng</title>

<meta name="description"
	content="Dynamic tables and grids using jqGrid plugin" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- basic styles -->

<link href="assets/css/bootstrap.min.css" rel="stylesheet" />
<link href="assets/css/bootstrap-responsive.min.css" rel="stylesheet" />
<link rel="stylesheet" href="assets/css/font-awesome.min.css" />

<!--[if IE 7]>
		  <link rel="stylesheet" href="assets/css/font-awesome-ie7.min.css" />
		<![endif]-->

<!-- page specific plugin styles -->

<link rel="stylesheet" href="assets/css/jquery-ui-1.10.3.full.min.css" />
<link rel="stylesheet" href="assets/css/datepicker.css" />
<link rel="stylesheet" href="assets/css/ui.jqgrid.css" />

<!-- fonts -->

<link rel="stylesheet" href="assets/css/ace-fonts.css" />

<!-- ace styles -->

<link rel="stylesheet" href="assets/css/ace.min.css" />
<link rel="stylesheet" href="assets/css/ace-responsive.min.css" />
<link rel="stylesheet" href="assets/css/ace-skins.min.css" />

<!--[if lte IE 8]>
		  <link rel="stylesheet" href="assets/css/ace-ie.min.css" />
		<![endif]-->

<!-- inline styles related to this page -->

<!-- ace settings handler -->

<script src="assets/js/ace-extra.min.js"></script>
</head>
<body>
	<span id="navbar"> </span>
	<div class="main-container container-fluid">
	<div id="test"></div>
		<div class="main-container-inner">
			<div class="sidebar" id="sidebar">
			</div>
			
			<div class="main-content">
				<div class="page-content">	
					<div class="page-header">						
						<h1><span id="viewOrder_page-header" class="viewOrder_page-header">Đơn hàng</span>
						<small>
							<i class="icon-double-angle-right"></i>
							<span id="viewOrder_orderDetails" class="viewOrder_orderDetails">Chi tiết đơn hàng</span>
						</small>
						</h1>
					</div>					
					<div class="row-fluid">
						<div class="span12 well alert-info">
							<span id="createdStampOrder" class="createdStampOrder"><b>Ngày tạo</b></span>: <span id="createdStampTime"></span><br/>
							<span id="viewOrder_orderStatus" class="viewOrder_orderStatus"><b>Trạng thái đơn hàng</b></span>: <span id="current_orderStatus"></span>														
						</div>
					</div>
					<div class="row-fluid">
						<div class="row-fluid">
							<div class="span6">
								<div class="widget-header">
									<h5><span id="viewOrder_billToParty" class="viewOrder_billToParty">
										Hóa đơn chuyển đến...</span>
									</h5>																
								</div>
								<div class="widget-body">
			 						<div class="widget-main" id="billToParty">
			 							
			 						</div>
			 					</div>	
							</div>
							<div class="span6">
								<div class="widget-header">
									<h5><span id="viewOrder_tranportInfo">Thông tin vận chuyển</span></h5>																
								</div>
								<div class="widget-body">
			 						<div class="widget-main" id="shippingInfomation">
			 							
			 						</div>
			 					</div>	
							</div>
						</div>			
						<div class="row-fluid">
							<div class="span6" id="productPromosInfo">
								
							</div>
						</div>			
						<div class="space-12"></div>														
						<div class="row-fluid">
							<div class="span12">
								<div class="widget-box">
									<div class="widget-header header-color-blue">
										<h5 class="bigger lighter"><i class="icon-table"></i> 
											<span id="viewOrder_orderItem" class="viewOrder_orderItem">Sản phẩm đặt hàng</span>
										</h5>
									</div>
									<div class="widget-body">
										 <div class="widget-main no-padding">
											  <table id="table_order_items" class="table table-striped table-bordered table-hover">
											  	<thead>
											  		<tr>
											  			<th><span id="viewOrder_productName">Tên sản phẩm</span></th>
											  			<th><span id="viewOrder_productQty">Số lượng</span></th>
											  			<th><span id="viewOrder_produtcAjustment">Giảm giá/KM</span></th>											  			
											  			<th><span id="viewOrder_productPrice">Giá 1 SP</span></th>
											  			<th><span id="viewOrder_productSubTotal">Tổng</span></th>
											  		</tr>
											  	</thead>
											  	<tbody>
											  		
											  	</tbody>
											  	<tfoot>
											  		
											  	</tfoot>
											  </table>
										  </div>
									</div>
								</div>		
							</div>
						</div>
															
						<hr/>						
						<div class="row-fluid">							
							<button class="btn btn-info" id="payment_finish_btn">
								Thanh toán</button>
							<button class="btn btn-success" onclick="location='createOrderAdvance.html'">
								<i class="icon-undo"></i> Quay lại</button>	
						</div>
					</div>	
				</div>
			</div>
		</div>
	</div>
	<script type="text/javascript">
		window.jQuery
				|| document
						.write("<script src='assets/js/jquery-2.0.3.min.js'>"
								+ "<"+"/script>");
	</script>

	<!-- <![endif]-->

	<!--[if IE]>
		<script type="text/javascript">
		 window.jQuery || document.write("<script src='assets/js/jquery-1.10.2.min.js'>"+"<"+"/script>");
		</script>
		<![endif]-->

	<script type="text/javascript">
		if ("ontouchend" in document)
			document
					.write("<script src='assets/js/jquery.mobile.custom.min.js'>"
							+ "<"+"/script>");
	</script>
	<script src="assets/js/bootstrap.min.js"></script>
	
	<!-- page specific plugin scripts -->
	<script type="text/javascript" src="assets/js/jquery-ui-1.10.3.custom.min.js"></script>

	<script type="text/javascript" src="assets/js/jquery.ui.touch-punch.min.js"></script>
	<script src="assets/js/date-time/bootstrap-datepicker.min.js"></script>
	<script src="assets/js/jqGrid/jquery.jqGrid.min.js"></script>
	<script src="assets/js/jqGrid/i18n/grid.locale-en.js"></script>
	<script src="assets/js/bootbox.min.js"></script>
	<!-- ace scripts -->

	<script src="assets/js/ace-elements.min.js"></script>
	<script src="assets/js/ace.min.js"></script>

	<!-- inline scripts related to this page -->
	<script src="assets/js/languages/language.js" type="text/javascript"></script>
	
	<script type="text/javascript">
		var languageObject = null;
		var lang = null;
		var key_order_status = null;
		var key_payment_finish_btn_btn = "viewOrder_payment";
		function language_select(language){
			//alert("test");			
			lang = language;
			languageObject = changeLanguage('config/viewOrder.json', lang);
			//console.log(key_payment_finish_btn_btn);
			$("#payment_finish_btn").text(languageObject[key_payment_finish_btn_btn][lang]);
			$("#current_orderStatus").text(languageObject[key_order_status][lang]);			
			//console.log(languageObject);
		}
		jQuery(function($){
			$.get("header.html", function(data) {
				$('#navbar').html(data);
			}, 'html').fail(function() {
				console.log('arge', arguments)
			});
			$.get("sidebar.html", function (data) {
	        	$('#sidebar').html(data);  
	        }, 'html').fail(function(){
	            console.log('arge', arguments)
	        });
			if(localStorage.viewOrderId){
				getOrderStatus(localStorage.viewOrderId);
			}else{
				//bootbox.dialog()
				alert("error");
			}
			function getOrderStatus(orderId){
				$.ajax({
					url: localStorage.serverUrl + "mobileservices/control/orderstatus",
					crossDomain: true,
					type : 'POST',
					dataType : 'json',
					data: {
						orderId : orderId
					},
					success: function(data) {
						//$("#test").html(JSON.stringify(data["orderStatus"]));
						fillInfoOrder(data);
					},
					error: function(textStatus, errorThrown){
						
					}
				});			
			}
			
			$("#payment_finish_btn").click(function(){
				$(this).attr('disabled', true);
				if(languageObject){
					$(this).text(languageObject.viewOrder_paymenting[lang])
				}else{
					$(this).text('Thanh toán.....');	
				}
				
				$.ajax({
					url: localStorage.serverUrl + 'mobileservices/control/paymentFinish',
					type:'POST',
					crossDomain: true,
					data: {
						orderId: localStorage.viewOrderId											
					},
					async: false,
					dataType: 'json',
					success: function(data){
						bootbox.dialog("Đã nhận tiền!!!!",[{
							"label": "OK",
							"class": "btn-small btn-primary",
							"callback": function(){
								$("#current_orderStatus").empty();
								key_order_status = data.statusOrder;
								if(languageObject){									
									$("#payment_finish_btn").text(languageObject.viewOrder_paymentfinish[lang]);
									$("#current_orderStatus").html(languageObject[data.statusOrder][lang]);
								}else{
									$("#payment_finish_btn").text('Đã nhận tiền');
									$("#current_orderStatus").html(data.statusOrder + "Khách hàng đã thanh toán");
								}
								
							}
						}]);												
					},
					error: function(textStatus, errorThrown){
						bootbox.dialog("Xảy ra lỗi!",[{
							"label": "OK",
							"class": "btn-small btn-primary"
						}]);
						$("#payment_finish_btn").attr('disable', 'false');
						$("#payment_finish_btn").text('Thanh toán');
					}
				});
			});						
		});
		function fillInfoOrder(dataOrder){
			var partyBill = dataOrder["orderStatus"]["billToParty"];
			var orderItems = dataOrder["orderStatus"]["orderItems"];
			 
			if(partyBill){
				 address = partyBill.groupName;	
			}else{
				address = "Không có địa chỉ khi tạo đơn hàng";
			}
			var orderStatus = dataOrder["orderStatus"];
			var orderSubTotal = dataOrder["orderStatus"]["orderSubTotal"];
			var orderTaxTotal = dataOrder["orderStatus"]["orderTaxTotal"];
			var orderGrandTotal = dataOrder["orderStatus"]["orderGrandTotal"];
			var order_status_current = orderStatus.statusId;//not used
			var orderDate = new Date(dataOrder["orderStatus"]["orderHeader"]["orderDate"].time);
			
			$("#createdStampTime").html((orderDate.getMonth() + 1) + "/" + orderDate.getDate() + "/" + orderDate.getFullYear() + "&nbsp;" + orderDate.getHours() + ":" + orderDate.getMinutes() + ":" + orderDate.getSeconds());
			key_order_status = order_status_current;//for json file
			if(orderStatus.orderHeader.statusId == 'ORDER_APPROVED' || orderStatus.orderHeader.statusId == 'ORDER_COMPLETED'){
				$("#payment_finish_btn").attr('disabled', true);
				key_payment_finish_btn_btn = "viewOrder_paymentfinish";
				if(languageObject){					
					$("#payment_finish_btn").text(languageObject.viewOrder_paymentfinish[lang]);
					$("#current_orderStatus").html(languageObject.current_orderStatus[lang]);
				}else{
					$("#payment_finish_btn").text("Đã thanh toán");					
					$("#current_orderStatus").html(' Khách hàng đã thanh toán')
				}				
			}else{
				if(languageObject){					
				//	$("#payment_finish_btn").text(languageObject.viewOrder_paymentfinish[lang]);
					$("#current_orderStatus").html(languageObject.current_orderStatus[lang]);
				}else{
				//	$("#payment_finish_btn").text("Đã thanh toán");					
					$("#current_orderStatus").html(' Khách hàng chưa thanh toán')
				}
			}			
			
			$("#billToParty").append("<p class='alert alert-info'>Khách hàng: " + address +" </p>");
			var foot = $("#table_order_items").find('tfoot');
			foot.append("<tr><td colspan='5' style='text-align: right'><b>Tổng phụ: " + orderSubTotal + "</b></td></tr>");
			foot.append("<tr><td colspan='5' style='text-align: right'><b>Thuế: " + orderTaxTotal + "</b></td></tr>");
			foot.append("<tr><td colspan='5' style='text-align: right'><b>Tổng: " + orderGrandTotal + "</b></td></tr>");
			for(var orderItem in orderItems){
				var productName = orderItems[orderItem].itemDescription;
				var quantity = orderItems[orderItem].quantity;
				var unitPrice = orderItems[orderItem].unitPrice;	
				var ajustmentTotal =  dataOrder["orderStatus"][orderItems[orderItem].orderId + "_"+ orderItems[orderItem]["orderItemSeqId"]+ "_adjustmentsTotal"];
				var itemTotal = orderStatus[orderStatus.orderId + "_" + orderItems[orderItem].orderItemSeqId + "_total"];
				var trItem = "<tr><td>"+ productName + "</td><td>"+ quantity +"</td><td>"+ ajustmentTotal +"</td><td>"+ unitPrice +"</td><td>"+ itemTotal +"</td></tr>"
				$("#table_order_items").append(trItem);
			}
			
			if(!jQuery.isEmptyObject(orderStatus["shippingAddress"])){
				var shippingaddress ="";
				if(orderStatus["shippingAddress"]["toName"]){
					shippingaddress += orderStatus["shippingAddress"]["toName"] + " ";
				}
				shippingaddress += orderStatus["shippingAddress"].address1;
				if(orderStatus["shippingAddress"].city !== null){
					shippingaddress += ", " + orderStatus["shippingAddress"].city;
				}					
			}
			if(shippingaddress){
				shippingAddr = shippingaddress; 
			}else{
				shippingAddr = "Chưa được thiết lập";
			}
			$("#shippingInfomation").append("<p class='alert alert-info'>" + shippingAddr +"</p>");
			
			//hien thi thong tin KM cho don hang
			if(!jQuery.isEmptyObject(dataOrder.orderStatus.productPromo)){
				insertPromosInfo(dataOrder.orderStatus.productPromo);	
			}					
		}
		
		function insertPromosInfo(promosInfo){
			var promosDiv = "<div class='space-12'></div>" +							
								"<div class='widget-box transparent'>" +
									"<div class='widget-header'>" +
										"<h5 class='bigger lighter'>CTKM áp dụng cho đơn hàng</h5>" +
									"</div>" + 
									"<div class='widget-body'>" +
									 "<div class='widget-main no-padding'>" +
										"<ul class='unstyled list-striped pricing-table-header'>" ;			
			for(var index in promosInfo){
				promosDiv +="<li><i class='icon-caret-right blue'></i>" + promosInfo[index] + "</li>";
			}
			promosDiv += "</ul></div></div></div>"; 
			$("#productPromosInfo").append(promosDiv);
			$("#productPromosInfo").parent().after("<hr/>");
		}
	</script>
</body>

